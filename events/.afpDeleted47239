<?php 
define('BASE_URL', 'http://www.spurlock.illinois.edu/education/calendar/');
require_once(dirname(__FILE__).'/fm/FileMaker.php'); //packaged with filemaker.  Not modified.
  //echo"gaguuuu";
  
  
  date_default_timezone_set('America/Chicago');
    $date = time () ;
     $day = date('d', $date) ;
    $thismonth = date('m', $date) ;
    $thisyear = date('Y', $date) ;
  $month = $_GET["month"];
    if(empty($month)) {
        $month = $thismonth;
        }
      $year = $_GET["year"];
    if(empty($year)) {
        $year = $thisyear;
        }


if (!defined('DATABASE_SERVER_IP')) define('DATABASE_SERVER_IP', 'http://128.174.89.159/');   
//const DATABASE_SERVER_IP = "http://128.174.89.159/";
$fm3 = new FileMaker();
$fm3->setProperty('database', 'Web_Events');
$fm3->setProperty('hostspec', DATABASE_SERVER_IP);
$fm3->setProperty('username', NULL);
$fm3->setProperty('password', NULL);


$findCommand = $fm3->newFindCommand('Web_Events');   //Ex. During export, connectfm is called to get all active records for the index page.
  $findCommand->addFindCriterion('Published', 'Yes');
   $findCommand->addFindCriterion('Date_Start_Year', $year);
    $findCommand->addFindCriterion('Date_Start_Month', $month);
  $findCommand->addSortRule('Date_Start', 1, FILEMAKER_SORT_ASCEND);
   $findCommand->addSortRule('Date_End', 2, FILEMAKER_SORT_ASCEND);
   $findCommand->addSortRule('Time_Start_New', 3, FILEMAKER_SORT_ASCEND);


  $result = $findCommand->execute();
  if (FileMaker::isError($result)) { 
 echo "<p>Error: " . $result->getMessage() . "</p>"; 
 exit;}

 $records = $result->getRecords();


if($_POST['action'] == 'call_this') {

  echo'<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta charset="utf-8" />    <title>Events</title>
    <link rel="stylesheet" href="../css/app.css" />
</style>

     <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/foundicons/3.0.0/foundation-icons.css">
    
    <!--<script type="text/javascript" src="http://www.spurlock.illinois.edu/support/jquery.js"></scrip>-->
    <script type="text/javascript" src="http://www.spurlock.illinois.edu/support/c_config.js"></script>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>

$(document).ready(function(){
   $(this).addClass("filter_hide");
    });
</script>
   </head>
  
  <body>';

 

    foreach($records as $record){
    global $day, $thismonth, $thisyear, $month, $year;
      $eventTitle = $record->getField('Title');
      
      $dateStart = $record->getField('Date_Start');
      $dateEnd = $record->getField('Date_End');
      $displayStart = $record->getField('Date_Start_Display');
      $displayEnd = $record->getField('Date_End_Display');
      $timeStart = $record->getField('Time_Start');
      $timeEnd = $record->getField('Time_End');
      $cost = $record->getField('Cost');
      $type1 = $record->getField('Type_Primary');
       $type2 = $record->getField('Type_Secondary');


    
      $description = html_entity_decode( $record->getField('Event_Description'));
     // $eventid = $record->getField('eventid');
      $photo = $record->getField('Photograph_Link1');
      $photoAlt =  $record->getField('Photograph_Alt_Text1');
      $photo2 = $record->getField('Photograph_Link2');
      $photoAlt2 = $record->getField('Photograph_Alt_Text2');
      //$infolink1 = $record->getField('Info_Link1');
      //$namelink1 = $record->getField('Info_Link1_Name');
      //$externallink1 = $record->getField('External_Link1'];
      //$infolink2 = $record->getField('Info_Link2');
     // $namelink2 = $record->getField('Info_Link2_Name');
      //$externallink2 = $record->getField('External_Link2');
      //$infolink3 = $record->getField('Info_Link3');
     // $namelink3 = $record->getField('Info_Link3_Name');
     // $externallink3 = $record->getField('External_Link3');
      $datespan = $record->getField('Date_Span');
      $type = $record->getField('Type');
      $tags = preg_split("/(\r\n|\n|\r)/", $type2);
      //Added by MTR [7.15.11]
      $eventID = $record->getField('eventid');
            
      
      $checkm = substr($dateStart,0,2);
      $checky = substr($dateStart,-4,4);
   

        // These are used to see if the event falls in the current month/year
      
      //checks if event falls in current month/year 
      if((substr($dateEnd,0,2) == $month && substr($dateEnd,-4,4) == $year) || ($checkm == $month && $checky == $year)
        && (intval(substr($dateStart,3,2) )< intval($day) && $checkm==date(m)) ) {
      
    

     
              echo"<div class=\"small-12 medium-12 large-12 columns filter_option panel";

if ($type1 == "Performance")
          {
            echo" performance";
           }

if ($type1 == "Talk")
          {
            echo" talk";
           }

if ($type1 == "Film")
          {
            echo" film";
           }

if ($type1 == "Hands-on")
          {
            echo" handson";
           }

if ($type1 == "Workshop")
          {
            echo" workshop";
           }

if (strpos($type2,'Family-Friendly') !== false)
          {
            echo" family";
           }

if (strpos($type2, 'Exhibit-Related') !== false)
          {
            echo" exhibit";
           }

if (strpos($type2, 'ALERT') !== false)
          {
            echo" alert";
           }


echo " \">";


$month_char=$month;
switch ($month) {
    case "1":
       $month_char="Jan.";
        break;
    case "2":
        $month_char="Feb.";
        break;
    case "3":
        $month_char="Mar.";
        break;
         case "4":
        $month_char="Apr.";
        break;
         case "5":
        $month_char="May";
        break;
         case "6":
        $month_char="Jun.";
        break;
         case "7":
        $month_char="Jul.";
        break;
         case "8":
        $month_char="Aug.";
        break;
         case "9":
        $month_char="Sep.";
        break;
         case "10":
        $month_char="Oct.";
        break;
         case "11":
        $month_char="Nov.";
        break;
         case "12":
        $month_char="Dec.";
        break;
    }

echo "<div class='small-2 medium-1 large-1 columns'><p style='text-align: left'>"  
. $month_char . 
"</p><p style='text-align: left'>" . substr($dateStart,3,2). 
"</p><p style='text-align: left'>". $starty = substr($dateStart,6,4).  
"</p></div>"; 
   echo "

<div class='small-10 medium-4 large-4 columns'>";

if($photo)  {
          // [10.13.10] MTR: Modified next 6 lines to fix margin issues when displaying two images side by side.
          echo "
           <img src='" .BASE_URL. "" . $photo . "' alt='" . BASE_URL. "" . $photoAlt . "'>";
         } else{
echo "
          <img src='http://placehold.it/300x200&text=[Type]'>";
         }

         
         echo "</div> <div class='small-10 medium-7 large-7 columns'><h5>
         <a href='http://w2.spurlock.illinois.edu/events/event.php?ID=".$eventID. "'>" .$eventTitle. "</a></h5>

<p><span class='radius secondary label'><a href='#'>". $type1 . "</a></span>";


if(!empty($type2)){
 for ($i = 0; $i < count($tags); ++$i) {
       echo '<span class="radius secondary label"><a href="#">'. $tags[$i] . '</a></span> ';

    }


}


        echo "</p></div>

</div>



";
          }
      
}

echo'  <script src="../bower_components/jquery/dist/jquery.min.js"></script>
    <script src="../bower_components/foundation/js/foundation.min.js"></script>
    <script src="../js/app.js"></script>
    

</body>
</html>';

}
?>

